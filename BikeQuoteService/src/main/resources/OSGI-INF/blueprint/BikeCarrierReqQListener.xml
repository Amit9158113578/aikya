<?xml version="1.0" encoding="UTF-8"?>
<blueprint xmlns="http://www.osgi.org/xmlns/blueprint/v1.0.0"
       xmlns:camel="http://camel.apache.org/schema/blueprint"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="http://www.osgi.org/xmlns/blueprint/v1.0.0 http://www.osgi.org/xmlns/blueprint/v1.0.0/blueprint.xsd
       http://camel.apache.org/schema/blueprint http://camel.apache.org/schema/blueprint/camel-blueprint.xsd">

<camelContext trace="false" streamCache="true" threadNamePattern="BIKECARRIERQUOTE" id="BikeCarrierReqQContext" xmlns="http://camel.apache.org/schema/blueprint">
 <onException>
    <exception>java.net.SocketTimeoutException</exception>
    <exception>java.net.SocketException</exception>
    <exception>java.net.ConnectException</exception>
    <handled>
      <constant>true</constant>
    </handled>
    <log message="Bike quote service seems to be down or not responded within stipulated time frame"/>
    <process ref="ExceptionMQMSGProcessor" customId="true" id="BikeException"/>
  </onException>
  <onException>
    <exception>org.apache.camel.component.http4.HttpOperationFailedException</exception>
    <handled>
      <constant>true</constant>
    </handled>
    <log message="Bike quote service HttpOperationFailed : check input values provided "/>
    <process ref="ExceptionMQMSGProcessor" customId="true" id="ExcepProcessor"/>
  </onException>
  <onException>
    <exception>com.idep.bikequote.exception.processor.ExecutionTerminator</exception>
    <exception>java.lang.Exception</exception>
    <handled>
      <constant>true</constant>
    </handled>
    <log message="Bike Quote process terminated"/>
    <process ref="ExceptionMQMSGProcessor" customId="true" id="CustomExceptionProcessor"/>
  </onException>
   <route id="CarrierBikeReqQListener">
    <from uri="activemq:queue:CarrierBikeReqQ" id="CarrierReqQ">
      <description/>
      </from>
       <bean ref="BikeQuoteRequestListener" method="onMessage" id="validateProduct" />
       <process ref="BikeRequestQProcessor" id="BikeRequestProcessor"/>
       <choice id="CarrierDataValidation">
         	 <when id="DataNotFound">
            	<simple>${header.clientDataFound} == "No"</simple>
            		 <process ref="BikeMQMsgProcessor" id="BikeMQMsgProcessor"/>
            	 	 <process ref="ResponseQueueProcessor" id="BikeResponseQueueProcessor"/>
            	</when>
            	<when id="DataFound">
            		<simple>${header.clientDataFound} == "Yes"</simple>
      			 	<process ref="BikeExtServiceReqProcessor" id="BikeExtServiceReqProcessor"/>
      			 	<process ref="ValidateServiceRequest" id="ValidateServiceRequest"/>
      			 	 <loop id="quoteServiceInvoke" >
			             <header>noOfServiceInvoke</header>
			                 <choice id="validateQuoteServiceInvokeStatus">
	 							<when id="success">
								    <simple>${header.invokeservice} == "True"</simple>
                         		      <process ref="UpdateStageProcessor" id="TransformServiceRequest" />
            	 		 		      <process ref="BikeQuoteLoggerProcessor" id="BikeLoggerProcessor"/>
               						  <to pattern="InOut" uri="webservconsumer://invoke" id="serviceInvoke" />
                					   <log message="response from invoke service:${body}"></log>
                					   <process ref="ValidateQuoteServiceResponse" id="ValidateResponse" />
			                     </when>
			                    </choice>
			                 </loop>
			                 <process ref="BikeMQMsgProcessor" id="BikeMQMsgQuoteProcessor"/>
            	 	 	     <process ref="ResponseQueueProcessor" id="BikeResponseQuoteProcessor"/>
       				</when>
       			</choice>
       		</route>
  </camelContext>

</blueprint>
