<?xml version="1.0" encoding="UTF-8"?>
<blueprint xmlns="http://www.osgi.org/xmlns/blueprint/v1.0.0"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:cxf="http://camel.apache.org/schema/blueprint/cxf"
	xsi:schemaLocation="
       http://www.osgi.org/xmlns/blueprint/v1.0.0 http://www.osgi.org/xmlns/blueprint/v1.0.0/blueprint.xsd
        http://camel.apache.org/schema/blueprint/cxf http://camel.apache.org/schema/blueprint/cxf/camel-cxf.xsd
       http://camel.apache.org/schema/blueprint http://camel.apache.org/schema/blueprint/camel-blueprint.xsd">
       
       <cxf:rsServer id="TataAIGTravelProposalEndpoint" address="/tataaigtravelpolicyproposal" 
	serviceClass="com.idep.proposal.service.TravelProposalService" loggingFeatureEnabled="true">
		<cxf:providers>
			<bean class="org.apache.cxf.rs.security.cors.CrossOriginResourceSharingFilter"/>
		</cxf:providers>
	</cxf:rsServer>
	
	<camelContext streamCache="true" id="TataAIGTravelProposalContext" xmlns="http://camel.apache.org/schema/blueprint">
  <dataFormats>
			<xmljson forceTopLevelObject="true" skipWhitespace="true" trimSpaces="true" skipNamespaces="true"
			expandableProperties="Insured PlanCode" removeNamespacePrefixes="true" id="TataAIGjsonxml" />
			<xmljson forceTopLevelObject="true" skipWhitespace="true"
				trimSpaces="true" skipNamespaces="true" removeNamespacePrefixes="true"
				id="TataAIGxmljson" />
  </dataFormats>
  <onException>
			<exception>java.net.SocketTimeoutException</exception>
			<exception>java.net.SocketException</exception>
			<handled>
				<constant>true</constant>
			</handled>
			<log message="TataAIG travel proposal service seems to be down" />
			<process ref="ProposalExceptionProcessor" customId="true" id="TataAIGTraProposalExceptionProcessor" />
	</onException>
	<onException>
			<exception>org.apache.camel.component.http4.HttpOperationFailedException</exception>
			<handled>
				<constant>true</constant>
			</handled>
			<log message="TataAIG travel proposal Http Operation Failed : check input provided" />
			<process ref="ProposalExceptionProcessor" customId="true" id="TataAIGHTTPProposalExceptionProcessor" />
	</onException>
	<onException>
			<exception>com.idep.proposal.exception.processor.ExecutionTerminator</exception>
			<exception>java.lang.Exception</exception>
			<handled>
				<constant>true</constant>
			</handled>
			<log message="TataAIG travel proposal process terminated" />
			<process ref="ProposalExceptionProcessor" customId="true" id="TataAIGTraGenericException" />
			<marshal>
				<json prettyPrint="true" library="Jackson" />
			</marshal>
	</onException>	
<route id="TataAIGTravelProposalRoute">
		<from uri="cxfrs:bean:TataAIGTravelProposalEndpoint" />
		<choice id="TataAIGTravelDecisionMaker">
			<when id="TataAIGProposalReq">
				<simple>${header.operationName} == "submitTravelProposal"</simple>
				<log message="Inside TataAIG Travel proposal request"/>
					<bean ref="TravelProposalServiceImpl" method="submitTravelProposal" id="TataAIGProposalSubmitReq"/>
					<process ref="TravelProposalReqProcessor" id="TataAIGTravelProposalReqProcessor" />
					<process ref="TravelProposalReqPostProcessor" id="TataAIGTravelProposalReqPostProcessor" />
					<process ref="ProposalAddressProcessor" id="TataAIGProposalAddressProcessor" />
					<process ref="TravelProposalReqLogProcessor" id="TataAIGTravelProReqLogProcessor" />
					<process ref="TravelPolicyLogProcessor" id="TataAIGLogProcessor1" />
					<!-- <when id="policyStatusSuccessPOSTSuccBASETrue">
						<simple>${header.baseEnvStatus} == "true"</simple>
						<log message="Base env status true" />
						<to uri="direct:proposalCreateRequest" />
					</when> -->
					<!-- <when id="policyStatusSuccessPOSTSuccBASEFalse">
						<simple>${header.baseEnvStatus} == "false"</simple> -->
						<log message="Base env status false" />
						<multicast  id="TataAIGTravelPropRequestMSG">
							<pipeline>
								<to uri="direct:proposalCreateRequest" />
							</pipeline>
							<pipeline>
								<process ref="TravelPolicyLogProcessor" id="TataAIGTravelLogProcessor" />	
								<process ref="TravelProposalResHandler" id="TataAIGTravelProposalResHandler1" />
								<to pattern="InOut" uri="xpathmapper://xpathmapdata" id="TataAIGWbserviceResponseMapper" />
								<log message=" Tata AIG New mapper output:  ${body}"/>
								<process ref="TravelProposalResProcessor" id="TataAIGTravelProposalResProcessor" />
								<process ref="ProposalReqDBStore" id="TataAIGTravelProposalReqDBStore" />
								<process ref="TravelPolicyLogProcessor" id="TataAIGTravelLogProcessor" />
								<process ref="ProposalResProcessor" id="TataAIGTravelProposalResProcessor1" />
								<bean ref="TravelProposalServiceImpl" method="submitTravelProposal" id="TataAIGTravelProposalResponse" />
								<marshal>
									<json prettyPrint="true" library="Jackson" />
								</marshal>	 	
								</pipeline>
						</multicast>
			   		</when>	
 			   	<when id="TataAIGTravelPolicyCreator">
					<simple>${header.operationName} == "createPolicy"</simple>
					<log message="TataAIG Travel : createPolicy request received" />
					<bean ref="TravelPolicySubmitServiceImpl" method="submitPolicy"
						id="TataAIGTravelPolicyServiceRequest" />
					<process ref="TravelPolicyLogProcessor" id="TataAIGTravelPolicyLogProcessor" />
					<multicast>
						<pipeline>
							<process ref="PaymentResponseUpdateProcessor" id="TataAIGTravelPaymentResProcessor" />
							<log message="TataAIG  PaymentResponseUpdateProcessor response: ${body}"/>
							<process ref="ProposalReqDBStore" id="TataAIGTravelPolicyReqDBStore" />
							<log message="Payment response added in database for TataAIG Travel " />
						</pipeline>
						<pipeline>
							<process ref="PaymentResponseValidator" id="TataAIGTravelPaymentResValidator" />
							<process ref="TravelPolicyReqProcessor" id="TataAIGTravelPolicyReqProcessor" /> 
							<process ref="TravelPolicyProcessor" id="TataAIGTravelPolicyProcessor" />
							<to pattern="InOut" uri="xpathmapper://xpathmapdata" id="TataAIGTravelXPathMapper" />
							<log message="TataAIG Travel Policy XPath Mapper response ${body}" />
							<unmarshal ref="TataAIGjsonxml" id="TataAIGJSONTOXML" />
							<process ref="XMLCharEmitter" id="TataAIGXMLCharEmitter" />
							<log message="TataAIG Travel XML Proposal Request : ${body}" />
							<process ref="TataAIGSoapReqGenerator" id="TataAIGSoapReqGenerator" />
							<log message="TataAIG Travel Policy SoapReqFormatter response ${body}" />
							<to pattern="InOut" uri="webservconsumer://invoke" id="FutuGeneHealthProposalURL" />
							<log message="TataAIG Travel Policy response ${body}" />
							<process ref="TataAIGSoapResFormatter" id="TataAIGSoapResFormatter"/>
    						<marshal ref="TataAIGxmljson" id="TataAIGXMLTOJSON"/>
    						<log message=" Tata AIG XMLJSON:  ${body}"/>
    						<process ref="TataAIGTravelResponseProcessor" id="TataAIGTravelProposalResHandler" />
							<process ref="TravelCarrierPolicyResponseProcessor" id="TravelCarrierPolicyResponseProcessor" />
							<log message="TataAIG Travel Input to TravelPolicyREQCONF : ${body}" />
							
							<to pattern="InOut" uri="xpathmapper://xpathmapdata" id="FutureGenTravelXPathMapper" />
							<process ref="TravelPolicyReqHandler" id="FutureGenTravelPolicyReqHandler" />
							<process ref="ProposalReqDBStore" id="FutureGenErgoTravelProposalReqDBStore" />
							<process ref="TravelPolicyResHandler" id="FutureGenTravelPolicyResHandler" />
							<log message="TataAIG Travel Input to TravelPolicyRESCONF : ${body}" />
							<to pattern="InOut" uri="xpathmapper://xpathmapdata" id="FutureGenPolicyResMapperUI" />
							<multicast>
								<pipeline>
									<process ref="TravelPolicyReqHandler" id="TataAIGTravelPolicyRes" />
									<process ref="UserProfileReqProcessor" id="TataAIGTravelUserProfileReqProcessor" />
						<to pattern="InOnly" uri="activemq:queue:TATAAIGTravelPolicyDocReqQ" id="TATAAIGTRAVELPolicyDocReqQ" />
									
								</pipeline>
								<pipeline>
									<process ref="TravelPolicyResLogProcessor" id="TataAIGTravelPolicyResLogProcessor" />
									<process ref="TravelPolicyLogProcessor" id="TataAIGTravelLogProcessor5" />
									<process ref="TravelPolicyReqHandler" id="TataAIGTravelPolicyResHandler" />
									<process ref="TravelPolicyResProcessor" id="TataAIGTravelPolicyResProcessor" />
									<bean ref="TravelPolicySubmitServiceImpl" method="sendMessage"
										id="TataAIGTravelPolicyServiceResponse" />
										<log message="TataAIG  Sccessfully completed : ${body}"/>
								</pipeline>
							</multicast>
						</pipeline>
					</multicast>
			</when>
 			   		
			  </choice>			
    </route>
    <route id="TataAIGPolicyDocQRoute">
			<from uri="activemq:queue:TATAAIGTravelPolicyDocReqQ" id="TataAIGPolicyDocQ">
				<description />
			</from>
			<log message="TataAIG starting its doc download process" />
			<bean ref="TravelPolicyDocServiceImpl" method="onMessage"
						id="TataAIGTravelPolicyServiceRequest1" />
			<log message="TataAIG starting its doc download process1 : ${body}" />
			<process ref="PolicyDocumentReqProcessor" id="TataAIGTravelPolicyDocProcessor" />
			<process ref="TravelPolicyLogProcessor" id="TataAIGTravelLogProcessor6" />
			<to pattern="InOut" uri="xpathmapper://xpathmapdata" id="TataAIGXPathMapperForFetchDoc" />
			<unmarshal ref="TataAIGjsonxml" id="TataAIGJSONTOXML1" />
			<log message="TataAIG Fetch Policy Document  JSON To XML Conversion : ${body}" />
			<process ref="XMLCharEmitter" id="TataAIGXMLCharEmitter23" />
			<log message="TataAIG Travel XML PolicyDoc Request : ${body}" />
<!-- 			<process ref="TataAIGDocSoapReqGenerator" id="TataAIGDocSoapReqGenerator" />
 -->			<log message="TataAIGSoapReqGenerator SOAP Conversion Done : ${body}" />
			<to pattern="InOut" uri="webservconsumer://invoke" id="TataAIGecthDocURL" />
			<log message="mapper Fetch Policy Document responce   : ${body}" />
			<process ref="TataAIGPolicyDocSOAPResponseFormatter" id="TataAIGSoapResFormatter1"/>
			<process ref="PolicyDocumentResProcessor" id="ReligarePolicyDocumentResProcessor" />
			<process ref="UserProfilePolicyUpdateProcessor" id="RelUserProfilePolicyUpdateProcessor" />
			<process ref="TravelPolicyLogProcessor" id="TataAIGPolicyDocTravelLogProcessor5" />
	</route> 
   <route id="createProposalRoute">
			<from uri="direct:proposalCreateRequest" />
			<process ref="TravelProposalDBReqProcessor" id="TataAIGTravelProposalDBReqProcessor" />
			<to pattern="InOut" uri="xpathmapper://xpathmapdata" id="TataAIGXPathMapperBASE" />
			<process ref="TravelPolicyLogProcessor" id="TataAIGTravelLogProcessor61" />
			<process ref="ProposalReqDBStore" id="TataAIGProposalReqDBStore" />
			<process ref="ProposalResProcessor" id="TataAIGTravelProposalResProcessor2" />
			<bean ref="TravelProposalServiceImpl" method="sendMessage" id="TataAIGTravelProposalServiceImpl"/>
			<marshal>
				<json prettyPrint="true" library="Jackson" />
			</marshal>
	</route>
	

  </camelContext>
  
  
</blueprint>
			 
					