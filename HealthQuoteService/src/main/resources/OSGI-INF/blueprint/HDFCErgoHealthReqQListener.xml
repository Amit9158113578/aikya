<?xml version="1.0" encoding="UTF-8"?>
<blueprint xmlns="http://www.osgi.org/xmlns/blueprint/v1.0.0"
       xmlns:camel="http://camel.apache.org/schema/blueprint"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="http://www.osgi.org/xmlns/blueprint/v1.0.0 http://www.osgi.org/xmlns/blueprint/v1.0.0/blueprint.xsd
       http://camel.apache.org/schema/blueprint http://camel.apache.org/schema/blueprint/camel-blueprint.xsd">

<camelContext trace="false" streamCache="true" threadNamePattern="HealthHDEFERGO" id="HEDFCERGOHealthReqQContext" xmlns="http://camel.apache.org/schema/blueprint">
  <onException>
    <exception>java.net.SocketTimeoutException</exception>
    <handled>
      <constant>true</constant>
    </handled>
    <log message="HDFC ERGO Health service not responded within stipulated time frame"/>
    <process ref="ExceptionMQMSGProcessor" customId="true" id="HDFCERGOHealthExceptionMQMSGProcessor"/>
    <to pattern="InOnly" uri="activemq:queue:HDFCERGOHealthResQ?timeToLive=120000&amp;includeSentJMSMessageID=true"/>
  </onException>
   <onException>
    <exception>com.idep.healthquote.exception.processor.ExecutionTerminator</exception>
    <exception>java.lang.Exception</exception>
    <handled>
      <constant>true</constant>
    </handled>
    <log message="HDFCErgo Health quote process terminated"/>
    <process ref="ExceptionMQMSGProcessor" customId="true" id="HDFCErgoHealthExceptionMQMSGProcessor"/>
     <to pattern="InOnly" uri="activemq:queue:HDFCERGOHealthResQ?timeToLive=120000&amp;includeSentJMSMessageID=true"/>
  </onException>
  <route id="HDEFERGOHealthReqQListener">
    <from uri="activemq:queue:HDFCERGOHealthReqQ" id="FromHDFCERGOHealthReqQ">
      <description/>
    </from>
    <bean ref="P365HealthReqQListener" method="onMessage" id="HDFCErgoHealthReqQBean"/>
    <process ref="HealthRequestQProcessor" id="HDFCErgoHealthReqQProcessor"/>
    <process ref="HealthQuoteLoggerProcessor" id="HDFCErgoQuoteLoggerProcessor1"/>
    <process ref="HealthDroolReqServiceTaxProcessor" id="HDFCErgoHealthReqServiceTaxQProcessor"/>
    <process ref="HealthDroolSelfAgeProcessor" id="HDFCHealthDroolSelfAgeProcessor"/>
    
    <process ref="DroolReqFormProcessor" id="HDFCErgoDroolReqProcessor"/>
    
    <recipientList>
      <simple>${header.quoteURL}</simple>
    </recipientList>
    <bean ref="HealthQuoteResponse" method="sendQuoteResponse"/>
    <process ref="DroolResponseFormProcessor" id="HDFCErgoHealthDroolResFormProcessor"/>
    <process ref="DroolQuoteResRiderProcessor" id="HDFCErgoDroolQuoteResRiderProcessor"/>
    <process ref="CalculateDOBMinMaxProcessor" id="HDFCMemberDOBProcessor"/>
    <process ref="PremiumRatioCalculateProcessor" id="HDFCPremiumRatioCalculateProcessor"/>
    <process ref="CalculateDeductibleProcessor" id="HDFCDeductibleCalculateProcessor"/>
    <process ref="HealthQuoteResponseProcessor" id="HDFCErgoQuoteResponseProcessor"/>
    <process ref="HealthQuoteLoggerProcessor" id="HDFCErgoQuoteLoggerProcessor2"/>
    <multicast id="HDFCErgoHealthQuoteResponseMSG">
      <pipeline>
        <process ref="HealthQuoteDBSender" id="HDFCErgoHealthQuoteDBSender"/>
        <to pattern="InOnly" uri="activemqSecondary:queue:HealthQuoteResultsQ"/>
        <process ref="HealthQuoteLoggerProcessor" id="HDFCErgoQuoteLoggerProcessor3"/>
      </pipeline>
      <pipeline>
      <process ref="CarrierQuoteServiceResLogger" id="HDFCErgoHealthServiceResLogger"/>
    <process ref="MQMsgProcessor" id="HDFCErgoMQMsgReqProcessor"/>
    <!-- <wireTap uri="activemqSecondary:queue:HDFCERGOHealthResQ?includeSentJMSMessageID=true"/> -->
    <to pattern="InOnly" uri="activemq:queue:HDFCERGOHealthResQ?timeToLive=120000&amp;includeSentJMSMessageID=true"/>
    <process ref="HealthQuoteLoggerProcessor" id="HDFCErgoQuoteLoggerProcessor4"/>
    </pipeline>
    </multicast>
   
  </route>
</camelContext>

</blueprint>
