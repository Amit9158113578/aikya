<?xml version="1.0" encoding="UTF-8"?>
<blueprint xmlns="http://www.osgi.org/xmlns/blueprint/v1.0.0"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:cxf="http://camel.apache.org/schema/blueprint/cxf"
	xsi:schemaLocation="
       http://www.osgi.org/xmlns/blueprint/v1.0.0 http://www.osgi.org/xmlns/blueprint/v1.0.0/blueprint.xsd
        http://camel.apache.org/schema/blueprint/cxf http://camel.apache.org/schema/blueprint/cxf/camel-cxf.xsd
       http://camel.apache.org/schema/blueprint http://camel.apache.org/schema/blueprint/camel-blueprint.xsd">

	<cxf:rsServer id="HDFCErgoTravelProposalEndpoint" address="/hdfcergotravelPolicyProposal" 
	serviceClass="com.idep.proposal.service.TravelProposalService" loggingFeatureEnabled="true">
		<cxf:providers>
			<bean class="org.apache.cxf.rs.security.cors.CrossOriginResourceSharingFilter"/>
		</cxf:providers>
	</cxf:rsServer>
	
  <camelContext streamCache="true" id="HDFCErgoTravelProposalContext" xmlns="http://camel.apache.org/schema/blueprint">
  <dataFormats>
			<xmljson forceTopLevelObject="true" rootName="Session"
				skipWhitespace="true" trimSpaces="true" skipNamespaces="true"
				removeNamespacePrefixes="true" id="HDFCjsonxml" />
			<xmljson forceTopLevelObject="true" skipWhitespace="true"
				trimSpaces="true" skipNamespaces="true" removeNamespacePrefixes="true"
				id="HDFCxmljson" />
  </dataFormats>
    <onException>
			<exception>java.net.SocketTimeoutException</exception>
			<exception>java.net.SocketException</exception>
			<handled>
				<constant>true</constant>
			</handled>
			<log message="HDFC ERGO travel proposal service seems to be down" />
			<process ref="ProposalExceptionProcessor" customId="true" id="HDFCTraProposalExceptionProcessor" />
	</onException>
	<onException>
			<exception>org.apache.camel.component.http4.HttpOperationFailedException</exception>
			<handled>
				<constant>true</constant>
			</handled>
			<log message="HDFC ERGO travel proposal Http Operation Failed : check input provided" />
			<process ref="ProposalExceptionProcessor" customId="true" id="HDFCHTTPProposalExceptionProcessor" />
	</onException>
	<onException>
			<exception>com.idep.proposal.exception.processor.ExecutionTerminator</exception>
			<exception>java.lang.Exception</exception>
			<handled>
				<constant>true</constant>
			</handled>
			<log message="HDFC travel proposal process terminated" />
			<process ref="ProposalExceptionProcessor" customId="true" id="HDFCTraGenericException" />
			<marshal>
				<json prettyPrint="true" library="Jackson" />
			</marshal>
	</onException>
   	
   	<route id="HDFCTravelProposalRoute">
		<from uri="cxfrs:bean:HDFCErgoTravelProposalEndpoint" />
		<choice id="HDFCTravelDecisionMaker">
			<when id="HDFCProposalReq">
				<simple>${header.operationName} == "submitTravelProposal"</simple>
				<log message="Inside HDTC Travel proposal request"/>
					<bean ref="TravelProposalServiceImpl" method="submitTravelProposal" id="HDFCTraProposalSubmitReq"/>
					<process ref="TravelProposalReqProcessor" id="HDFCTravelProposalReqProcessor" />
					<process ref="TravelProposalReqPostProcessor" id="TataAIGTravelProposalReqPostProcessor" />
					<process ref="ProposalAddressProcessor" id="TataAIGProposalAddressProcessor" />
					<process ref="TravelProposalReqLogProcessor" id="HDFCErgoTravelProReqLogProcessor" />
					<process ref="TravelPolicyLogProcessor" id="HDFCTravelLogProcessor1" />
					<!-- <when id="policyStatusSuccessPOSTSuccBASETrue">
						<simple>${header.baseEnvStatus} == "true"</simple>
						<log message="Base env status true" />
						<to uri="direct:proposalCreateRequest" />
					</when> -->
					<!-- <when id="policyStatusSuccessPOSTSuccBASEFalse">
						<simple>${header.baseEnvStatus} == "false"</simple> -->
						<log message="Base env status false" />
						<multicast  id="HDFCTravelPropRequestMSG" parallelProcessing="true">
							<pipeline>
								<to uri="direct:proposalCreateRequest" />
							</pipeline>
							<pipeline>
								<process ref="HDFCTravelPlanCodeProcessor" id="HDFCTravelPlanCodeProcessor"/>
								<process ref="TravelPolicyLogProcessor" id="HDFCTravelLogProcessor" />	
								<to pattern="InOut" uri="xpathmapper://xpathmapdata" id="HDFCTravelXPathMapper" />
								<process ref="TravelProposalAttributeReqProcessor" id="HDFCErgoTravelAttributeReqProcessor" />
								<multicast id="HDFCTravelRequestDBStore" parallelProcessing="true">
								<pipeline>
									<process ref="CarrierProposalRequestDBStore" id="CarrierProposalReqDBstore" />
								</pipeline>
								<pipeline>
								<process ref="TravelProposalServiceReqLogProcessor" id="HDFCServiceReqLogger" />									
								<to pattern="InOut" uri="webservconsumer://invoke" id="HDFCErgoTravelURLCall" />
								<multicast id="HDFCTravelResponseDBStore" parallelProcessing="true">
								<pipeline>
								<process ref="CarrierProposalResponseDBStore" id="CarrierProposalReqDBstore" />
										</pipeline>
								<pipeline>
								<process ref="TravelSoapResFormatter" id="HDFCErgoSoapResposneFormatter" />
								<marshal ref="HDFCjsonxml" id="PROPOSALXMLTOJSON" />
								<process ref="HDFCTravelProposalResponseValidator" id="HDFCProposalResponseValidator" />
								<process ref="TravelProposalResHandler" id="HDFCErgoTravelProposalResHandler" />
								<to pattern="InOut" uri="xpathmapper://xpathmapdata" id="HDFCWebserviceResponseMapper" />
								<process ref="TravelProposalResProcessor" id="HDFCErgoTravelProposalResProcessor" />
								<process ref="ProposalReqDBStore" id="HDFCErgoTravelProposalReqDBStore" />
								<process ref="TravelPolicyLogProcessor" id="HDFCTravelLogProcessor3" />
								<process ref="ProposalResProcessor" id="HDFCErgoTravelProposalResProcessor1" />
								<bean ref="TravelProposalServiceImpl" method="submitTravelProposal" id="HDFCTravelProposalResponse" />
								<!--<marshal>
									<json prettyPrint="true" library="Jackson" />
								</marshal>	 -->	
								</pipeline>
								</multicast>
								</pipeline>
			   			        </multicast>		   			        
			   			    </pipeline>  
			   			</multicast>  
			   		</when>			   		
			   		<when id="HDFCErgoTravelPolicyCreator">
					<simple>${header.operationName} == "createPolicy"</simple>
					<log message="HDFC Ergo Travel : createPolicy request received" />
					<bean ref="TravelPolicySubmitServiceImpl" method="submitPolicy"
						id="HDFCTravelPolicyServiceRequest" />
					<process ref="TravelPolicyLogProcessor" id="HDFCTravelPolicyLogProcessor" />
					<multicast>
						<pipeline>
							<process ref="PaymentResponseUpdateProcessor" id="HDFCTravelPaymentResProcessor" />
							<process ref="ProposalReqDBStore" id="HDFCTravelPolicyReqDBStore" />
							<log message="Payment response added in database for HDFC Ergo Travel " />
						</pipeline>
						<pipeline>
							<process ref="PaymentResponseValidator" id="HDFCTravelPaymentResValidator" />
							<process ref="TravelPolicyReqProcessor" id="HDFCTravelPolicyReqProcessor" />
							<process ref="TravelPolicyLogProcessor" id="HDFCTravelLogProcessor4" />
							<process ref="TravelCarrierPolicyResponseProcessor" id="TravelCarrierPolicyResponseProcessor" />
							<to pattern="InOut" uri="xpathmapper://xpathmapdata" id="FutureGenTravelXPathMapper" />
							<process ref="TravelPolicyReqHandler" id="HDFCTravelPolicyReqHandler" />
							<process ref="ProposalReqDBStore" id="HDFCErgoTravelProposalReqDBStore" />
							<process ref="TravelPolicyResHandler" id="HDFCTravelPolicyResHandler" />
							<to pattern="InOut" uri="xpathmapper://xpathmapdata" id="FutureGenPolicyResMapperUI" />
							<multicast>
								<pipeline>
									<process ref="TravelPolicyReqHandler" id="HDFCTravelPolicyRes" />
									<process ref="UserProfileReqProcessor" id="HDFCTravelUserProfileReqProcessor" />
								</pipeline>
								<pipeline>
									<process ref="TravelPolicyResLogProcessor" id="HDFCTravelPolicyResLogProcessor" />
									<process ref="TravelPolicyLogProcessor" id="HDFCTravelLogProcessor5" />
									<process ref="TravelPolicyReqHandler" id="HDFCErgoTravelPolicyResHandler" />
									<process ref="TravelPolicyResProcessor" id="HDFCErgoTravelPolicyResProcessor" />
									<bean ref="TravelPolicySubmitServiceImpl" method="sendMessage"
										id="HDFCTravelPolicyServiceResponse" />
									<!-- <marshal> <json prettyPrint="true" library="Jackson"/> </marshal> -->
								</pipeline>
							</multicast>
						</pipeline>
					</multicast>
				</when>
			  </choice>			
    </route>
   <route id="createProposalRoute">
			<from uri="direct:proposalCreateRequest" />
			<process ref="TravelProposalDBReqProcessor" id="HDFCTravelProposalDBReqProcessor" />
			<to pattern="InOut" uri="xpathmapper://xpathmapdata" id="HDFCXPathMapperBASE" />
			<process ref="TravelPolicyLogProcessor" id="HDFCTravelLogProcessor6" />
			<process ref="ProposalReqDBStore" id="HDFCProposalReqDBStore" />
			<process ref="ProposalResProcessor" id="HDFCTravelProposalResProcessor" />
			<bean ref="TravelProposalServiceImpl" method="sendMessage" id="HDFCTravelProposalServiceImpl"/>
			<marshal>
				<json prettyPrint="true" library="Jackson" />
			</marshal>
	</route>
  </camelContext>
</blueprint>
