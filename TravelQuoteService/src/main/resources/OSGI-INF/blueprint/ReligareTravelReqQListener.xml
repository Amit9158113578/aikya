<?xml version="1.0" encoding="UTF-8"?>
<blueprint xmlns="http://www.osgi.org/xmlns/blueprint/v1.0.0"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:cxf="http://camel.apache.org/schema/blueprint/cxf"
	xsi:schemaLocation="
       http://www.osgi.org/xmlns/blueprint/v1.0.0 http://www.osgi.org/xmlns/blueprint/v1.0.0/blueprint.xsd
        http://camel.apache.org/schema/blueprint/cxf http://camel.apache.org/schema/blueprint/cxf/camel-cxf.xsd
       http://camel.apache.org/schema/blueprint http://camel.apache.org/schema/blueprint/camel-blueprint.xsd">
	<camelContext threadNamePattern="ReligareTravelThread:#counter#"
		id="ReligareTravelReqQContext" xmlns="http://camel.apache.org/schema/blueprint">
		<onException>
			<exception>java.net.ConnectException</exception>
			<exception>java.net.SocketTimeoutException</exception>
			<exception>java.net.SocketException</exception>
			<handled>
				<constant>true</constant>
			</handled>
			<log
				message="Religare TRAVEL quote service seems to be down or not responded within stipulated time frame" />
			<process ref="ExceptionMQMSGProcessor" customId="true"
				id="RELIGARETravelExceptionMQMSGProcessor" />
			<to pattern="InOnly"
				uri="activemq:queue:ReligareTravelResQ?timeToLive=120000&amp;includeSentJMSMessageID=true" />
		</onException>
		<onException>
			<exception>org.apache.camel.component.http4.HttpOperationFailedException</exception>
			<handled>
				<constant>true</constant>
			</handled>
			<log message="Religare TRAVEL quote service HttpOperationFailed : check input values provided " />
			<process ref="ExceptionMQMSGProcessor" customId="true" id="RELIGARETravelHTTPExcpMQProcessor" />
			<to pattern="InOnly" uri="activemq:queue:ReligareTravelResQ?timeToLive=120000&amp;includeSentJMSMessageID=true" />
		</onException>
		<onException>
		    <exception>com.idep.travelquote.exception.processor.ExecutionTerminator</exception>
		    <handled>
		      <constant>true</constant>
		    </handled>
		    <log message="Religare TRAVEL quote service Terminated "/>
		    <process ref="ExceptionMQMSGProcessor" customId="true" id="RELIGARETravelExceptionQuoteProcessor"/>
		    <to pattern="InOnly" uri="activemq:queue:ReligareTravelResQ?timeToLive=120000&amp;includeSentJMSMessageID=true"/>
	  </onException>
		  <route id="ReligareTravelReqQListener">
		  	<from uri="activemq:queue:ReligareTravelReqQ" id="FromReligareTravelReqQ">
	      			<description/>
	      	</from>
	      	<bean ref="P365TravelReqQListener" method="onMessage" id="ReligareTravelReqQBean"/>
	      	<process ref="TravelRequestQProcessor" id="RELIGARETravelReqQProcessor"/>
	 		<process ref="TravelReqRiderProcessor" id="RELIGARETravelReqRiderProcessor"/>
	 		<process ref="CalculateMemberCountProcessor" id="RELIGMemberCountProcessor"/>
			<process ref="FindPremiumRateProcessor" id="ReligareFindPremiumRateProcessor"/> 
	 		<choice id="ReligarePremiumFailureResonse">
			 <when id="ReligareTravelResQ">
				<simple>${header.validatePremium} == "False"</simple>
			 	<process ref="TravelMQMsgProcessor" id="ReligareTravelError"/>
				<to pattern="InOnly" uri="activemq:queue:ReligareTravelResQ?timeToLive=120000&amp;includeSentJMSMessageID=true"/>
			</when>
	    	<when id="ReligarePremiumSuccessResponse">
	    	<simple>${header.validatePremium} == "True"</simple>
	 		
	 		<process ref="TravelTravellersDobCalProcessor" id="FutureGeneraliTravelTravellersDobCalProcessor"/>
			<to pattern="InOut" uri="xpathmapper://xpathmapdata" id="ReligareTravelXPathMapper" />
			<process ref="RequestTransformSaver" id="ReligareTransReqSave"/>
		   	<process ref="TravelDroolURLFromProcessor" id="RELIGAREDroolReqProcessor"/>	 	   	    
		    <process ref="CarrierQuoteServiceReqLogger" id="CarrierQuoteServiceReqLogger"/>
		    <log message="Religare Trave : quoteURL : ${header.quoteURL} headers ${headers} header quoteType: ${header.quoteType}: message body :${body}  "/>
		    <recipientList>
	     			 <simple>${header.quoteURL}</simple>
	   		</recipientList>
	   		<bean ref="TravelQuoteResponse" method="sendQuoteResponse"/>
	   		<process ref="TravelDroolResponseProcessor" id="TravelDroolResponseProcessor"/>

	   		 <to pattern="InOut" uri="xpathmapper://xpathmapdata" id="RelTravelXPathMapper"/>

	   		<process ref="TravelQuoteResponseProcessor" id="ReligareQuoteResponseProcessor"/>
	   		<process ref="TravelQuoteLoggerProcessor" id="ReligareQuoteLoggerProcessor2"/>
	   		<!--  <process ref="TravelQuoteExResHandler" id="TravelQuoteExResHandler"/>
	   		<to pattern="InOut" uri="mapper://mapdata" id="TravelMapper"/>
	   		<process ref="TravelExtServiceResProcessor" id="BikeExtServiceResProcessor"/>-->
		     <multicast id="ReligareQuoteResponseMSG">
		      <pipeline>
		        <process ref="TravelQuoteDBSender" id="ReligareQuoteDBSender"/>
		        <to pattern="InOnly" uri="activemqSecondary:queue:TravelQuoteResultsQ"/>
		      </pipeline>
		      <pipeline>
		       	<process ref="CarrierQuoteServiceResLogger" id="ReligareCarrierQuoteServiceResLogger"/>
		        <process ref="TravelMQMsgProcessor" id="ReligareTravelMQMsgReqProcessor"/>
		       <!-- <wireTap uri="activemqSecondary:queue:ReligareTravelResQ?includeSentJMSMessageID=true"/> -->
		         <to pattern="InOnly" uri="activemq:queue:ReligareTravelResQ?timeToLive=120000&amp;includeSentJMSMessageID=true"/>
		      </pipeline>
	      </multicast>
			</when>
	      </choice>

		  </route>
</camelContext>
</blueprint>
       