<?xml version="1.0" encoding="UTF-8"?>
<blueprint xmlns="http://www.osgi.org/xmlns/blueprint/v1.0.0"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:cxf="http://camel.apache.org/schema/blueprint/cxf"
       xsi:schemaLocation="
       http://www.osgi.org/xmlns/blueprint/v1.0.0 http://www.osgi.org/xmlns/blueprint/v1.0.0/blueprint.xsd
        http://camel.apache.org/schema/blueprint/cxf http://camel.apache.org/schema/blueprint/cxf/camel-cxf.xsd
       http://camel.apache.org/schema/blueprint http://camel.apache.org/schema/blueprint/camel-blueprint.xsd">

 <camelContext threadNamePattern="KotakLife:#counter#" id="KotakLifeReqQContext" xmlns="http://camel.apache.org/schema/blueprint">
    <dataFormats>
    <xmljson forceTopLevelObject="true" skipWhitespace="true" expandableProperties="quotationProductDOList quotationProductInsuredDOList quotationProductAddOnDOList" trimSpaces="true" skipNamespaces="true" removeNamespacePrefixes="true" id="Kotakjsonxml"/>
    <xmljson forceTopLevelObject="true" skipWhitespace="true" trimSpaces="true" skipNamespaces="true" removeNamespacePrefixes="true" id="Kotakxmljson"/>
  </dataFormats>
  
  <onException>
    <exception>java.net.SocketTimeoutException</exception>
    <exception>java.net.SocketException</exception>
    <exception>java.net.ConnectException</exception>
    <handled>
      <constant>true</constant>
    </handled>
    <log message="KotakLife service seems to be down or not responded within stipulated time frame"/>
    <process ref="ExceptionMQMSGProcessor" customId="true" id="KotakLifeExceptionMQMSGProcessor"/>
    <to pattern="InOnly" uri="activemq:queue:KotakLifeResQ?timeToLive=120000&amp;includeSentJMSMessageID=true"/>
  </onException>
  <onException>
    <exception>org.apache.camel.component.http4.HttpOperationFailedException</exception>
    <handled>
      <constant>true</constant>
    </handled>
    <log message="KotakLife quote service HttpOperationFailed : check input values provided "/>
    <process ref="ExceptionMQMSGProcessor" customId="true" id="KotakLifeHTTPExceptionMQMSGProcessor"/>
    <to pattern="InOnly" uri="activemq:queue:KotakLifeResQ?timeToLive=120000&amp;includeSentJMSMessageID=true"/>
  </onException>
  <onException>
    <exception>com.idep.lifequote.exception.processor.ExecutionTerminator</exception>
    <handled>
      <constant>true</constant>
    </handled>
    <log message="KotakLife quote service Terminated "/>
    <process ref="ExceptionMQMSGProcessor" customId="true" id="KotakLifeExceptionQuoteProcessor"/>
    <to pattern="InOnly" uri="activemq:queue:KotakLifeResQ?timeToLive=120000&amp;includeSentJMSMessageID=true"/>
  </onException>
  <route id="KotakLifeReqQListener">
    <from uri="activemq:queue:KotakLifeReqQ" id="FromKotakLifeReqQ">
      <description/>
    </from>
    <bean ref="P365LifeReqQListener" method="onMessage" id="KotakLifeReqQBean"/>
    <process ref="LifeRequestQProcessor" id="KotakLifeReqQProcessor"/>
    <process ref="LifeQuoteLoggerProcessor" id="KotakLifeLoggerProcessor1"/>
    <process ref="LifeReqRiderProcessor" id="KotakLifeReqRiderProcessor"/>
    <process ref="LifeQuoteLoggerProcessor" id="KotakLifeLoggerProcessor2"/>
    <process ref="KotakSOAPReqProcessor" id="KotakSOAPReqProcessor1"/> 
    
    <log message="Kotak LifeQuote Input Request to mapper : ${body}"/>
    <to pattern="InOut" uri="xpathmapper://xpathmapdata" id="KotakLifeXPathMapper"/>
    <log message="Kotak LifeQuote Output of mapper: ${body}"/>
     
     <!--Call to Kotak Service -->
     <to pattern="InOut" uri="webservconsumer://invoke" id="KotakLifeQUOTEURL1"/>
    <log message="KotakLife quote webserverconsumer service response :${body} "/> 
   
    <!-- Converts Json to XML and Removes the unwanted characters -->
    <process ref="XMLCharEmitter" id="KotakXMLCharEmitter"/>
    
     <!-- XML to Json formatter -->
    <process ref="SOAPResponseFormatter" id="KotakSOAPResponseFormatter"/>
    <marshal ref="Kotakxmljson" id="KotakXMLTOJSON"/>
     
    <!--Rider request Transformer  -->
    <process ref="KotakRequestTransformer" id="KotakRequestTransformer"/>
	<process ref="KotakQuoteNumSetter" id="KotakQuoteResponseHandler"/>
	
     <!-- Call to 2nd mapper for sending details to UI-->
     <process ref="KotakQuoteResponseHandler" id="KotakQuoteResponseHandler"/>
    
    <log message="Kotak Life Service Input to mapper: ${body}"/>
    <to pattern="InOut" uri="xpathmapper://xpathmapdata" id="KotakLifeQUOTEURL2"/>
    <log message="Kotak Life Service Ouptput of mapper: ${body}"/>
     <process ref="PremiumRatioCalculateProcessor" id="kotakPremiumRatioCalculateProcessor"/>
    
    
    <!-- Added to get additional info in UI -->
    <process ref="LifeQuoteResponseProcessor" id="KotalLifeQuoteResponseProcessor"/>
       <process ref="LifeQuoteLoggerProcessor" id="KotakLifeLoggerProcessor6"/>
    
       
    <!--  <process ref="LifeDroolReqFromProcessor" id="KotakDroolReqProcessor"/>-->
    <process ref="LifeQuoteLoggerProcessor" id="KotakLifeLoggerProcessor3"/>
      <multicast id="KotakLifeQuoteResponseMSG">
          <pipeline>
            <log message="request/response sent to save Kotak LIFE quote in database"/>
            <process ref="LifeQuoteDBSender" id="KotakLIFELifeQuoteDBSender"/>
            <process ref="LifeQuoteLoggerProcessor" id="KotakLifeLoggerProcessor7"/>
            <to pattern="InOnly" uri="activemq:queue:LifeQuoteResultsQ"/>
          </pipeline>
          <pipeline>
        	<process ref="LifeMQMsgProcessor" id="KotakLifeMQProcessor"/>
        	<process ref="LifeQuoteLoggerProcessor" id="KotakLifeLoggerProcessor7"/>
        	
            <wireTap uri="activemqSecondary:queue:KotakLifeResQ?includeSentJMSMessageID=true"/>
        	<to pattern="InOnly" uri="activemq:queue:KotakLifeResQ?timeToLive=120000&amp;includeSentJMSMessageID=true"/>
        	<log message="KotakLifeResQ JMS Message Id from Q : ${header.JMSMessageID}"/>
          </pipeline>
        </multicast>
  </route>
</camelContext>
</blueprint>